# Copyright Contributors to the Packit project.
# SPDX-License-Identifier: MIT

---
kind: DeploymentConfig
apiVersion: apps.openshift.io/v1
metadata:
  name: postgres-13
  labels:
    service: postgres-13
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    service: postgres-13
  template:
    metadata:
      labels:
        service: postgres-13
        name: postgres-13
    spec:
      containers:
        - name: postgres
          image: quay.io/sclorg/postgresql-13-c9s
          imagePullPolicy: IfNotPresent
          env:
            - name: POSTGRESQL_USER
              valueFrom: {secretKeyRef: {name: postgres-secret, key: database-user}}
            - name: POSTGRESQL_PASSWORD
              valueFrom: {secretKeyRef: {name: postgres-secret, key: database-password}}
            - name: POSTGRESQL_DATABASE
              valueFrom: {secretKeyRef: {name: postgres-secret, key: database-name}}
            # https://www.postgresql.org/docs/13/kernel-resources.html#LINUX-MEMORY-OVERCOMMIT
            - name: PG_OOM_ADJUST_FILE
              value: "/proc/self/oom_score_adj"
            # https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-SHARED-BUFFERS
            - name: POSTGRESQL_SHARED_BUFFERS
              value: "{{ '242MB' if project == 'packit-prod' else '32MB' }}"
          ports:
            - containerPort: 5432
              protocol: TCP
          livenessProbe:
            exec:
              command:
                - /usr/libexec/check-container
                - --live
            failureThreshold: 3
            initialDelaySeconds: 120
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 10
#          readinessProbe:
#            exec:
#              command:
#                - /usr/libexec/check-container
#            failureThreshold: 3
#            initialDelaySeconds: 5
#            periodSeconds: 10
#            successThreshold: 1
#            timeoutSeconds: 1
          resources:
            # requests and limits have to be the same to have Guaranteed QoS
            requests:
              memory: "{{ '1.5Gi' if project == 'packit-prod' else '128Mi' }}"
              cpu: "{{ '300m' if project == 'packit-prod' else '100m' }}"
            limits:
              memory: "{{ '1.5Gi' if project == 'packit-prod' else '128Mi' }}"
              cpu: "{{ '300m' if project == 'packit-prod' else '100m' }}"
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/pgsql/data
            - name: postgres-config
              mountPath: /opt/app-root/src/postgresql-cfg
              readOnly: true
      restartPolicy: Always
      volumes:
        - name: postgres-data
          persistentVolumeClaim:
            claimName: postgres-13
        - name: postgres-config
          configMap:
            name: postgres-config
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: postgres-config
data:
  packit.conf: |-
    # Values based on https://pgtune.leopard.in.ua
    # default is 4.0. Use 1.1 for SSD storage
    random_page_cost = 1.1
    # default is 1. Use hundreds for SSD storage
    effective_io_concurrency = 200
    min_wal_size = 1GB
    max_wal_size = 4GB
    # (shared_buffers, effective_cache_size and max_connections can be set by env. vars
    # https://github.com/sclorg/postgresql-container/tree/generated/13#environment-variables-and-volumes)
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  ports:
    - name: postgres-port
      port: 5432
      targetPort: 5432
  selector:
    service: postgres-13
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-13
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: "{{ '4Gi' if deployment == 'prod' else '1Gi' }}"
